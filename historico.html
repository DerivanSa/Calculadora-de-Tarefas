<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Operações</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
            text-align: center;
            margin-top: 16px;
            
        }
        button {
            background-color: #007BFF;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        select {
            margin: 15px 0;
            padding: 10px;
            font-size: 16px;
        }
        .operation-item {
            display: flex;
            flex-direction: column;
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: left;
        }
        .operation-item span {
            margin-bottom: 5px;
        }
        .operation-item .actions {
            display: flex;
            justify-content: space-between;
        }
        .actions i {
            cursor: pointer;
            margin-left: 10px;
            margin-right: 10px;
        }
        .actions .fa-edit {
            color: #28a745;
            font-size: 18px;
        }
        .actions .fa-trash {
            color: #dc3545;
            font-size: 18px;
        }
        #popup-container {
            display: none; /* Mantém o pop-up oculto por padrão */
            position: fixed; /* Fixa a posição do pop-up em relação à tela */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Fundo semi-transparente */
            justify-content: center; /* Centraliza horizontalmente o conteúdo */
            align-items: center; /* Centraliza verticalmente o conteúdo */
            overflow: auto; /* Permite rolagem se o conteúdo for muito grande */
            padding: 20px; /* Adiciona espaçamento interno */
            box-sizing: border-box; /* Inclui o padding na largura e altura */
        }

        #popup {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 100%; /* Faz o pop-up ocupar 100% da largura disponível */
            max-height: 80%; /* Limita a altura do pop-up a 80% da altura da tela */
            overflow-y: auto; /* Adiciona rolagem vertical caso o conteúdo ultrapasse a altura */
            text-align: center;
            position: relative;
            box-sizing: border-box; /* Garante que o padding seja incluído na largura/altura total */
        }

        /* Ajustes para telas menores */
        @media (max-width: 600px) {
            #popup {
                max-width: 77%; /* Faz o pop-up ocupar toda a largura disponível */
                max-height: 90%; /* Aumenta a altura máxima para 90% da tela */
                padding: 20px; /* Reduz o padding para telas menores */
            }

            #popup-close {
                font-size: 24px; /* Aumenta o tamanho do botão de fechar para facilitar o toque */
            }
        }
        
        #popup-close {
            float: right;
            cursor: pointer;
            color: #333;
            font-size: 20px;
        }
        .footer {
            margin-top: 6px;
            font-size: 16px;
            color: #777;
            text-align: center;
            margin-bottom: 16px;
        }
        .footer a {
            color: #007BFF;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        #searchInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        select {
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        #jsonButton {
            background-color: #B5A44B;
        }

        #jsonButton:hover {
            background-color: #967D00; /* Cor mais escura para hover */
        }
        #excelButton {
            background-color: #008739;
        }

        #excelButton:hover {
            background-color: #007630; /* Cor mais escura para hover */
        }
        
        #orderBy {
            width: 100%; /* Ajusta o select para ocupar 100% da largura do container */
            padding: 10px; /* Mantém o padding igual ao do input */
            font-size: 16px; /* Mantém o tamanho da fonte igual ao do input */
            border-radius: 5px; /* Mantém a borda arredondada */
            border: 1px solid #ddd; /* Mantém a borda igual à do input */
            box-sizing: border-box; /* Garante que o padding seja incluído na largura total */
            appearance: none; /* Remove a aparência padrão do select para melhorar a customização */
            text-overflow: ellipsis; /* Adiciona reticências caso o texto seja muito longo */
            white-space: nowrap; /* Impede que o texto dentro do select quebre em várias linhas */
            overflow: hidden; /* Esconde qualquer conteúdo que ultrapasse os limites do select */
        }

        /* Opcional: Customização para o select, adicionando um ícone de dropdown */
        #orderBy {
            background: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%23000000"><path d="M5.5 7l4.5 4.5 4.5-4.5H5.5z"/></svg>') no-repeat right 10px center;
            background-size: 1rem;
            padding-right: 2rem; /* Dá espaço para o ícone de dropdown */
        }
    </style>
</head>
<body>
    <div class="container" id="history-container">
        <h1>Histórico de Operações</h1>
        <button onclick="clearHistory()">Limpar Histórico</button>
        <button onclick="window.location.href='index.html'" style="margin-top: 10px;">Voltar para Home</button>
        <button id="jsonButton" onclick="downloadJson()">Baixar JSON</button>
        <button id="excelButton" onclick="downloadExcel()">Baixar Excel</button>

        <select id="orderBy" onchange="sortHistory()">
            <option value="dateDesc">Mais Recentes para Mais Antigas</option>
            <option value="dateAsc">Mais Antigas para Mais Recentes</option>
            <option value="tasksDesc">Maior Número de Tarefas para Menor Número de Tarefas</option>
            <option value="tasksAsc">Menor Número de Tarefas para Maior Número de Tarefas</option>
            <option value="valueDesc">Maior Valor de Tarefa para Menor Valor de Tarefa</option>
            <option value="valueAsc">Menor Valor de Tarefa para Maior Valor de Tarefa</option>
            <option value="totalDesc">Maior Valor Total para Menor Valor Total</option>
            <option value="totalAsc">Menor Valor Total para Maior Valor Total</option>
        </select>

        <input type="text" id="searchInput" placeholder="Pesquisar notas..." onkeyup="searchNotes()">

        <div id="history-list" style="margin-top: 20px;"></div>
    </div>

    <div id="popup-container" onclick="closePopup(event)">
        <div id="popup">
            <span id="popup-close">&times;</span>
            <h2>Editar Nota</h2>
            <textarea id="editNote" rows="4" style="width: 100%;" oninput="this.value = this.value.replace(/\n/g, '')"></textarea>
            <button onclick="saveEditedNote()">Salvar</button>
        </div>
    </div>

    <div class="footer">
        &copy; 2024 <a href="https://github.com/DerivanSa" target="_blank">Derivan Souza</a> | 
        <a href="https://github.com/DerivanSa/Calculadora-de-Tarefas/" target="_blank">Calculadora de Tarefas</a>
    </div>

    <script>
        let currentEditIndex = null;
        let filteredHistory = [];
        let currentOrder = 'dateDesc'; // Armazena o filtro ativo

        function parseDate(dateString) {
            const [datePart, timePart] = dateString.split(', ');
            const [day, month, year] = datePart.split('/');
            return new Date(`${year}-${month}-${day}T${timePart}`);
        }

        function generateUniqueId() {
            return Date.now();
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('history')) || [];
            sortHistory(); // Ordena o histórico ao carregar
        }

        function saveOperation(operation) {
            let history = JSON.parse(localStorage.getItem('history')) || [];
            operation.id = generateUniqueId();
            history.push(operation);
            localStorage.setItem('history', JSON.stringify(history));
            sortHistory(); // Ordena ao salvar a operação
        }

        function displayHistory(history) {
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = '';

            history.forEach((operation) => {
                const item = document.createElement('div');
                item.className = 'operation-item';
                item.innerHTML = `
                    <span><strong>Data e Hora:</strong> ${operation.date}</span>
                    <span><strong>Unidade:</strong> ${operation.measure}</span>
                    <span><strong>Número de Tarefas:</strong> ${operation.numberOfTarefas}</span>
                    <span><strong>Valor da Tarefa:</strong> ${operation.multiplier || 'Não especificado'}</span>
                    <span><strong>Valor Total:</strong> ${operation.totalValue || 'Não especificado'}</span>
                    <span><strong>Notas:</strong> ${operation.note}</span>
                    <div class="actions">
                        <i class="fas fa-edit" onclick="editItem(${operation.id})">  Nota</i>
                        <i class="fas fa-trash" onclick="deleteItem(${operation.id})">  Excluir</i>
                    </div>
                `;
                historyContainer.appendChild(item);
            });
        }

        function sortHistory() {
            let history = filteredHistory.length > 0 ? filteredHistory : JSON.parse(localStorage.getItem('history')) || [];
            const orderBy = document.getElementById('orderBy').value || currentOrder;
            currentOrder = orderBy; // Atualiza o filtro ativo

            switch (orderBy) {
                case 'dateAsc':
                    history.sort((a, b) => parseDate(a.date) - parseDate(b.date));
                    break;
                case 'dateDesc':
                    history.sort((a, b) => parseDate(b.date) - parseDate(a.date));
                    break;
                case 'tasksAsc':
                    history.sort((a, b) => a.numberOfTarefas - b.numberOfTarefas);
                    break;
                case 'tasksDesc':
                    history.sort((a, b) => b.numberOfTarefas - a.numberOfTarefas);
                    break;
                case 'valueAsc':
                    history.sort((a, b) => a.multiplier - b.multiplier);
                    break;
                case 'valueDesc':
                    history.sort((a, b) => b.multiplier - a.multiplier);
                    break;
                case 'totalAsc':
                    history.sort((a, b) => a.totalValue - b.totalValue);
                    break;
                case 'totalDesc':
                    history.sort((a, b) => b.totalValue - a.totalValue);
                    break;
            }

            displayHistory(history);
        }

        function searchNotes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let history = JSON.parse(localStorage.getItem('history')) || [];

            if (searchTerm) {
                filteredHistory = history.filter(operation => 
                    operation.note.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredHistory = [];
            }

            displayHistory(filteredHistory.length > 0 ? filteredHistory : history);
        }

        function clearHistory() {
            if (confirm('Tem certeza que deseja limpar o histórico?')) {
                localStorage.removeItem('history');
                loadHistory();
            }
        }

        function editItem(id) {
            let history = JSON.parse(localStorage.getItem('history')) || [];
            const operation = history.find(op => op.id === id);
            if (operation) {
                currentEditIndex = id;
                document.getElementById('editNote').value = operation.note || '';
                document.getElementById('popup-container').style.display = 'flex';
            }
        }

        function saveEditedNote() {
            let history = JSON.parse(localStorage.getItem('history')) || [];
            const operationIndex = history.findIndex(op => op.id === currentEditIndex);
            if (operationIndex > -1) {
                history[operationIndex].note = document.getElementById('editNote').value;
                localStorage.setItem('history', JSON.stringify(history));
                sortHistory(); // Reordenar de acordo com o filtro ativo
                closePopup(); // Fechar o popup após salvar
            }
        }

        function closePopup(event) {
            const popupContainer = document.getElementById('popup-container');

            // Verifica se o clique foi fora do pop-up ou no "X"
            if (!event || event.target.id === 'popup-container' || event.target.id === 'popup-close') {
                popupContainer.style.display = 'none'; // Fechar o popup
            }
        }

        function deleteItem(id) {
            if (confirm('Tem certeza que deseja excluir este item?')) {
                let history = JSON.parse(localStorage.getItem('history')) || [];
                history = history.filter(op => op.id !== id);
                localStorage.setItem('history', JSON.stringify(history));
                loadHistory();
            }
        }

        function downloadJson() {
            let history = JSON.parse(localStorage.getItem('history')) || [];
            history.sort((a, b) => parseDate(a.date) - parseDate(b.date)); // Ordena do mais antigo para o mais novo

            // Reatribui IDs de forma sequencial
            history.forEach((operation, index) => {
                operation.id = index + 1;  // Começa a contagem a partir de 1
            });

            const jsonContent = JSON.stringify(history, null, 2);
            const encodedUri = encodeURI("data:application/json;charset=utf-8," + jsonContent);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", encodedUri);
            downloadAnchorNode.setAttribute("download", "historico.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function downloadExcel() {
            let history = JSON.parse(localStorage.getItem('history')) || [];
            history.sort((a, b) => parseDate(a.date) - parseDate(b.date)); // Ordena do mais antigo para o mais novo

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data e Hora,Unidade,Nascente,Norte,Sul,Poente,Número de Tarefas,Valor da Tarefa,Valor Total,Notas\n";

            history.forEach(operation => {
                const row = [
                    `"${operation.date}"`,  // Adiciona aspas duplas em torno da data e hora
                    operation.measure,
                    operation.nascente || '',
                    operation.norte || '',
                    operation.sul || '',
                    operation.poente || '',
                    operation.numberOfTarefas,
                    operation.multiplier || '',
                    operation.totalValue || '',
                    operation.note
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", encodedUri);
            downloadAnchorNode.setAttribute("download", "historico.csv");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
        });
    </script>
</body>
</html>
